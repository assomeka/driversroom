<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - ESTACUP</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="admin.js" defer></script>
  <style>
    /* RÃ©sumÃ© des voitures ESTACUP */
    #estacupCarSummary {
      margin: 6px 0 10px;
    }
    .car-summary-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .car-summary-item {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .car-summary-label {
      opacity: 0.85;
    }
    .car-summary-count {
      font-weight: 600;
    }

    /* Header carte ESTACUP + pill livrÃ©e */
    .estacup-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .estacup-card-header h4 {
      margin: 0;
    }
    .livery-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      font-size: 0.8rem;
      white-space: nowrap;
    }
    .livery-pill input[type="checkbox"] {
      accent-color: #22d3ee;
      transform: scale(1.1);
    }

    /* Licence pill (Rookie / Challenger / Pro) */
    .license-pill {
      margin-left: 4px;
      min-width: 95px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
      text-align: center;
    }
    .license-pill-rookie {
      border-color: #16a34a;
      color: #bbf7d0;
    }
    .license-pill-challenger {
      border-color: #2563eb;
      color: #bfdbfe;
    }
    .license-pill-pro {
      border-color: #dc2626;
      color: #fecaca;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <img src="meka.svg" alt="Logo MEKA" class="site-logo" />
  </header>
  <div class="container">
    <h2>Interface administrateur</h2>

    <div id="adminOnly" class="hidden">
      <p>Bienvenue, <span id="adminName"></span></p>

      <!-- Menu admin -->
      <nav class="admin-menu" style="display:flex;gap:10px;margin-bottom:20px;">
        <button data-section="results"> CrÃ©ation RÃ©sultats</button>
        <button data-section="incidents">Gestion Incidents</button>
        <button data-section="courses">Liste des Courses</button>
        <button data-section="estacup">Gestion ESTACUP</button>
        <!-- ðŸ‘‡ Onglet Votes -->
        <button data-section="votes">Votes</button>
      </nav>

      <!-- Section RÃ©sultats -->
      <section id="section-results" class="admin-section hidden">
        <h3>RÃ©sultats de course</h3>

        <!-- ===== ENTÃŠTE : Ã‰tape 1 â€“ Contexte course ===== -->
        <div class="course-box" id="contextBox">
          <h4>Ã‰tape 1 â€” Contexte</h4>

          <div style="display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));align-items:end">
            <div>
              <label for="isEstacup">Manche ESTACUP ?</label>
              <select id="isEstacup">
                <option value="yes">Oui</option>
                <option value="no">Non</option>
              </select>
            </div>

            <!-- Visible si ESTACUP = Oui -->
            <div id="roundWrap">
              <label for="estcRoundText">Round</label>
              <input type="text" id="estcRoundText" placeholder="Prologue, 1, 2, 3â€¦" />
            </div>

            <!-- Visible si ESTACUP = Non -->
            <div id="raceNameWrap" style="display:none">
              <label for="raceName">Nom de la course</label>
              <input type="text" id="raceName" placeholder="Ex: Endu Monza du Jeudi" />
            </div>

            <div>
              <label for="raceCircuit">Circuit</label>
              <input type="text" id="raceCircuit" placeholder="Ex: Monza" />
            </div>

            <div>
              <label for="raceDate">Date</label>
              <input type="date" id="raceDate" />
            </div>

            <!-- Splits : visible seulement quand on choisit JSON et ESTACUP = Oui -->
            <div id="splitCountWrap" style="display:none">
              <label for="splitCount">Nombre de splits</label>
              <select id="splitCount">
                <option value="1">1</option>
                <option value="2">2</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ===== Ã‰tape 2 â€“ Mode de saisie ===== -->
        <div class="course-box" id="modeBox">
          <h4>Ã‰tape 2 â€” Mode de saisie</h4>
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <label><input type="radio" name="inputMode" value="manual" id="modeManual" checked /> Saisie manuelle</label>
            <label><input type="radio" name="inputMode" value="json" id="modeJson" /> Import depuis fichiers JSON</label>
          </div>
        </div>

        <!-- ===== Mode JSON ===== -->
        <div class="course-box" id="jsonImportBox" style="display:none">
          <h4>Import automatique (JSON Assetto Corsa)</h4>

          <div id="filesWrap" style="margin-top:12px">
            <h5 style="margin:6px 0">Fichiers JSON (rÃ©sultats serveur)</h5>

            <!-- Split 1 -->
            <div class="course-box" style="padding:12px">
              <h4 style="margin:0 0 8px">Split 1</h4>
              <label> Sprint S1 (JSON) </label>
              <input type="file" id="fileSprintS1" accept=".json,application/json" />
              <label> Finale / Principale S1 (JSON) </label>
              <input type="file" id="fileMainS1" accept=".json,application/json" />
            </div>

            <!-- Split 2 (affichÃ© seulement si splitCount=2) -->
            <div id="split2Wrap" class="course-box" style="padding:12px;display:none">
              <h4 style="margin:0 0 8px">Split 2</h4>
              <label> Sprint S2 (JSON) </label>
              <input type="file" id="fileSprintS2" accept=".json,application/json" />
              <label> Finale / Principale S2 (JSON) </label>
              <input type="file" id="fileMainS2" accept=".json,application/json" />
            </div>

            <button id="analyzeJson">Analyser les fichiers</button>
          </div>

          <!-- Matching pilotes non trouvÃ©s -->
          <div id="matchBlock" class="course-box" style="display:none">
            <h4>Correspondance des pilotes non trouvÃ©s</h4>
            <p class="muted">Associe chaque nom importÃ© Ã  un pilote existant quand aucun lien automatique nâ€™a Ã©tÃ© trouvÃ©.</p>
            <div id="matchList"></div>
            <button id="applyMatching">Appliquer les correspondances</button>
          </div>

          <!-- AperÃ§u rÃ©sultats -->
          <div id="previewBlock" class="course-box" style="display:none">
            <h4>AperÃ§u des rÃ©sultats (finales)</h4>
            <div id="resultsPreview"></div>
            <button id="submitJsonResults">âœ… Enregistrer ces rÃ©sultats</button>
          </div>
        </div>

        <!-- ===== Mode MANUEL ===== -->
        <div class="course-box" id="manualBox">
          <h4>Mode manuel (classement par clic sur les pilotes)</h4>
          <div class="pilot-section">
            <div>
              <h4>Pilotes enregistrÃ©s</h4>
              <ul id="pilotList" class="pilot-list"></ul>
            </div>
            <div>
              <h4>Classement (ordre de clic)</h4>
              <ol id="rankingList" class="ranking-list"></ol>
            </div>
          </div>
          <button id="submitResults">Valider le classement</button>
        </div>
      </section>

      <!-- Section Incidents + RÃ©clamations -->
      <section id="section-incidents" class="admin-section hidden">
        <h3>Incidents / RÃ©clamations</h3>

        <div class="course-box" style="margin-bottom:24px">
          <h4>RÃ©clamations reÃ§ues</h4>
          <div id="reclamationsBox"></div>
        </div>

        <div class="course-box">
          <h4>CrÃ©er / Enregistrer un incident</h4>

          <div style="display:grid;gap:10px;grid-template-columns:1fr auto;">
            <div>
              <label for="incidentPilotSelect">Pilote impliquÃ© :</label>
              <select id="incidentPilotSelect"></select>
            </div>
            <div style="align-self:end">
              <button type="button" id="addIncidentPilot">âž• Ajouter</button>
            </div>
          </div>

          <ul id="incidentList" class="incident-list"></ul>

          <label for="incidentRaceSelect" style="margin-top:16px;display:block">Course concernÃ©e :</label>
          <select id="incidentRaceSelect"></select>

          <textarea id="incidentDescription" placeholder="Description de l'incident" rows="3" style="margin-top:10px"></textarea>

          <div style="margin-top:10px">
            <button type="button" id="submitIncident">âœ… Enregistrer l'incident</button>
          </div>
        </div>

        <div id="incidentHistory" style="margin-top:24px"></div>
      </section>

      <!-- Section Courses -->
      <section id="section-courses" class="admin-section hidden">
        <h3>Courses enregistrÃ©es</h3>
        <div id="courseList"></div>
      </section>

      <!-- Section ESTACUP -->
      <section id="section-estacup" class="admin-section hidden">
        <h3>Inscriptions ESTACUP</h3>
        <div id="estacupCarSummary" class="muted"></div>
        <div class="toolbar" style="margin:8px 0 14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <label for="estacupSort" style="white-space:nowrap;">Tri :</label>
          <select id="estacupSort">
            <option value="arrival">Ordre d'arrivÃ©e (rÃ©cent en haut)</option>
            <option value="updated">DerniÃ¨re mise Ã  jour</option>
            <option value="name">Nom</option>
            <option value="number">NÂ°</option>
          </select>
        </div>
        <div id="estacupList"></div>
      </section>

      <!-- Section Votes (admin) -->
      <section id="section-votes" class="admin-section hidden">
        <h3>Votes â€” RÃ©sultats</h3>

        <div class="course-box">
          <h4 style="margin:0 0 10px">Round 3</h4>
          <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin-bottom:8px">
            <div>ðŸ‡¨ðŸ‡³ Shanghai</div>
            <div><strong id="q3_a_cnt">0</strong> (<span id="q3_a_pct">0%</span>)</div>
          </div>
          <div class="bar bar-a" style="height:10px;background:#0b1220;border:1px solid #334155;border-radius:999px;overflow:hidden">
            <span id="q3_a_bar" style="display:block;height:100%;background:#22d3ee;width:0%"></span>
          </div>

          <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin:10px 0 8px">
            <div>ðŸ‡²ðŸ‡¾ Sepang</div>
            <div><strong id="q3_b_cnt">0</strong> (<span id="q3_b_pct">0%</span>)</div>
          </div>
          <div class="bar bar-b" style="height:10px;background:#0b1220;border:1px solid #334155;border-radius:999px;overflow:hidden">
            <span id="q3_b_bar" style="display:block;height:100%;background:#a78bfa;width:0%"></span>
          </div>

          <div class="muted" id="q3_total" style="margin-top:6px">Total : 0</div>
        </div>

        <div class="course-box">
          <h4 style="margin:0 0 10px">Round 5</h4>
          <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin-bottom:8px">
            <div>ðŸ‡§ðŸ‡­ Bahrain</div>
            <div><strong id="q5_a_cnt">0</strong> (<span id="q5_a_pct">0%</span>)</div>
          </div>
          <div class="bar bar-a" style="height:10px;background:#0b1220;border:1px solid #334155;border-radius:999px;overflow:hidden">
            <span id="q5_a_bar" style="display:block;height:100%;background:#22d3ee;width:0%"></span>
          </div>

          <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin:10px 0 8px">
            <div>ðŸ‡¶ðŸ‡¦ Losail</div>
            <div><strong id="q5_b_cnt">0</strong> (<span id="q5_b_pct">0%</span>)</div>
          </div>
          <div class="bar bar-b" style="height:10px;background:#0b1220;border:1px solid #334155;border-radius:999px;overflow:hidden">
            <span id="q5_b_bar" style="display:block;height:100%;background:#a78bfa;width:0%"></span>
          </div>

          <div class="muted" id="q5_total" style="margin-top:6px">Total : 0</div>
        </div>

        <p class="muted" style="margin-top:10px">
          Comptage depuis <code>estacup_votes</code> (1 doc par utilisateur : <code>q3</code>, <code>q5</code>, <code>locked</code>).
        </p>
      </section>

      <button id="goToDashboard">Retour Ã  la driver's room</button>
    </div>

    <p id="notAdmin" class="error hidden">AccÃ¨s refusÃ© : compte non administrateur.</p>
  </div>
</body>
</html>
