<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - ESTACUP</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="admin.js" defer></script>
</head>
<body>
  <header class="site-header">
    <img src="meka.svg" alt="Logo MEKA" class="site-logo" />
  </header>
  <div class="container">
    <h2>Interface administrateur</h2>

    <div id="adminOnly" class="hidden">
      <p>Bienvenue, <span id="adminName"></span></p>

      <!-- Menu admin -->
      <nav class="admin-menu" style="display:flex;gap:10px;margin-bottom:20px;">
        <button data-section="results"> Cr√©ation R√©sultats</button>
        <button data-section="incidents">Gestion Incidents</button>
        <button data-section="courses">Liste des Courses</button>
        <button data-section="estacup">Gestion ESTACUP</button>
        <button data-section="pilots">Gestion Pilotes</button>
      </nav>

      <!-- Section R√©sultats -->
      <section id="section-results" class="admin-section hidden">
        <h3>R√©sultats de course</h3>

        <!-- ===== ENT√äTE : √âtape 1 ‚Äì Contexte course ===== -->
        <div class="course-box" id="contextBox">
          <h4>√âtape 1 ‚Äî Contexte</h4>

          <div style="display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));align-items:end">
            <div>
              <label for="isEstacup">Manche ESTACUP ?</label>
              <select id="isEstacup">
                <option value="yes">Oui</option>
                <option value="no">Non</option>
              </select>
            </div>

            <!-- Visible si ESTACUP = Oui -->
            <div id="roundWrap">
              <label for="estcRoundText">Round</label>
              <input type="text" id="estcRoundText" placeholder="Prologue, 1, 2, 3‚Ä¶" />
            </div>

            <!-- Visible si ESTACUP = Non -->
            <div id="raceNameWrap" style="display:none">
              <label for="raceName">Nom de la course</label>
              <input type="text" id="raceName" placeholder="Ex: Endu Monza du Jeudi" />
            </div>

            <div>
              <label for="raceCircuit">Circuit</label>
              <input type="text" id="raceCircuit" placeholder="Ex: Monza" />
            </div>

            <div>
              <label for="raceDate">Date</label>
              <input type="date" id="raceDate" />
            </div>

            <!-- Splits : visible seulement quand on choisit JSON et ESTACUP = Oui -->
            <div id="splitCountWrap" style="display:none">
              <label for="splitCount">Nombre de splits</label>
              <select id="splitCount">
                <option value="1">1</option>
                <option value="2">2</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ===== √âtape 2 ‚Äì Mode de saisie ===== -->
        <div class="course-box" id="modeBox">
          <h4>√âtape 2 ‚Äî Mode de saisie</h4>
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <label><input type="radio" name="inputMode" value="manual" id="modeManual" checked /> Saisie manuelle</label>
            <label><input type="radio" name="inputMode" value="json" id="modeJson" /> Import depuis fichiers JSON</label>
          </div>
        </div>

        <!-- ===== Mode JSON ===== -->
        <div class="course-box" id="jsonImportBox" style="display:none">
          <h4>Import automatique (JSON Assetto Corsa)</h4>

          <div id="filesWrap" style="margin-top:12px">
            <h5 style="margin:6px 0">Fichiers JSON (r√©sultats serveur)</h5>

            <!-- Split 1 -->
            <div class="course-box" style="padding:12px">
              <h4 style="margin:0 0 8px">Split 1</h4>
              <label> Sprint S1 (JSON) </label>
              <input type="file" id="fileSprintS1" accept=".json,application/json" />
              <label> Finale / Principale S1 (JSON) </label>
              <input type="file" id="fileMainS1" accept=".json,application/json" />
            </div>

            <!-- Split 2 (affich√© seulement si splitCount=2) -->
            <div id="split2Wrap" class="course-box" style="padding:12px;display:none">
              <h4 style="margin:0 0 8px">Split 2</h4>
              <label> Sprint S2 (JSON) </label>
              <input type="file" id="fileSprintS2" accept=".json,application/json" />
              <label> Finale / Principale S2 (JSON) </label>
              <input type="file" id="fileMainS2" accept=".json,application/json" />
            </div>

            <button id="analyzeJson">Analyser les fichiers</button>
          </div>

          <!-- Matching pilotes non trouv√©s -->
          <div id="matchBlock" class="course-box" style="display:none">
            <h4>Correspondance des pilotes non trouv√©s</h4>
            <p class="muted">Associe chaque nom import√© √† un pilote existant quand aucun lien automatique n‚Äôa √©t√© trouv√©.</p>
            <div id="matchList"></div>
            <button id="applyMatching">Appliquer les correspondances</button>
          </div>

          <!-- Aper√ßu r√©sultats -->
          <div id="previewBlock" class="course-box" style="display:none">
            <h4>Aper√ßu des r√©sultats (finales)</h4>
            <div id="resultsPreview"></div>
            <button id="submitJsonResults">‚úÖ Enregistrer ces r√©sultats</button>
          </div>
        </div>

        <!-- ===== Mode MANUEL ===== -->
        <div class="course-box" id="manualBox">
          <h4>Mode manuel (classement par clic sur les pilotes)</h4>
          <div class="pilot-section">
            <div>
              <h4>Pilotes enregistr√©s</h4>
              <ul id="pilotList" class="pilot-list"></ul>
            </div>
            <div>
              <h4>Classement (ordre de clic)</h4>
              <ol id="rankingList" class="ranking-list"></ol>
            </div>
          </div>
          <button id="submitResults">Valider le classement</button>
        </div>
      </section>

      <!-- Section Pilotes -->
      <section id="section-pilots" class="admin-section hidden">
        <h3>Gestion Pilotes</h3>

        <div class="course-box" style="margin-bottom:16px">
          <div style="display:grid;gap:10px;grid-template-columns:1fr auto">
            <input id="pilotSearch" type="text" placeholder="Rechercher (nom, email)"/>
            <button id="refreshPilots">‚Üª Rafra√Æchir</button>
          </div>
          <ul id="pilotAdminList" class="pilot-list" style="max-height:300px;overflow:auto;margin-top:10px"></ul>
        </div>

        <div class="course-box">
          <h4>Fiche pilote</h4>
          <div id="pilotFormEmpty" style="color:#94A3B8">S√©lectionne un pilote √† gauche.</div>
          <form id="pilotForm" class="hidden">
            <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <div>
                <label>Pr√©nom</label>
                <input id="pf_firstName"/>
              </div>
              <div>
                <label>Nom</label>
                <input id="pf_lastName"/>
              </div>
              <div>
                <label>Email</label>
                <input id="pf_email" type="email"/>
              </div>
              <div>
                <label>Date de naissance</label>
                <input id="pf_dob" type="date"/>
              </div>
              <div>
                <label>Licence ID</label>
                <input id="pf_licenseId"/>
              </div>
              <div>
                <label>Points E-Safety</label>
                <input id="pf_licensePoints" type="number" min="0" />
              </div>
              <div>
                <label>Classe de licence</label>
                <select id="pf_licenseClass">
                  <option value="Pro">Pro</option>
                  <option value="Challenger">Challenger</option>
                  <option value="Rookie">Rookie</option>
                </select>
              </div>
              <div>
                <label>E-Rating (lecture seule)</label>
                <input id="pf_eloRating" type="number" disabled />
              </div>
            </div>
            <div class="toolbar" style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
              <button id="pf_save" type="button">üíæ Enregistrer</button>
              <button id="pf_reset" type="button">‚Ü©Ô∏è R√©initialiser</button>
            </div>
          </form>
        </div>
      </section>
      
      <!-- Section Incidents + R√©clamations -->
      <section id="section-incidents" class="admin-section hidden">
        <h3>Incidents / R√©clamations</h3>

        <div class="course-box" style="margin-bottom:24px">
          <h4>R√©clamations re√ßues</h4>
          <div id="reclamationsBox"></div>
        </div>

        <div class="course-box">
          <h4>Cr√©er / Enregistrer un incident</h4>

          <div style="display:grid;gap:10px;grid-template-columns:1fr auto;">
            <div>
              <label for="incidentPilotSelect">Pilote impliqu√© :</label>
              <select id="incidentPilotSelect"></select>
            </div>
            <div style="align-self:end">
              <button type="button" id="addIncidentPilot">‚ûï Ajouter</button>
            </div>
          </div>

          <ul id="incidentList" class="incident-list"></ul>

          <label for="incidentRaceSelect" style="margin-top:16px;display:block">Course concern√©e :</label>
          <select id="incidentRaceSelect"></select>

          <textarea id="incidentDescription" placeholder="Description de l'incident" rows="3" style="margin-top:10px"></textarea>

          <div style="margin-top:10px">
            <button type="button" id="submitIncident">‚úÖ Enregistrer l'incident</button>
          </div>
        </div>

        <div id="incidentHistory" style="margin-top:24px"></div>
      </section>

      <!-- Section Courses -->
      <section id="section-courses" class="admin-section hidden">
        <h3>Courses enregistr√©es</h3>
        <div id="courseList"></div>
      </section>

      <!-- Section ESTACUP -->
      <section id="section-estacup" class="admin-section hidden">
        <h3>Inscriptions ESTACUP</h3>
        <div class="toolbar" style="margin:8px 0 14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <label for="estacupSort" style="white-space:nowrap;">Tri :</label>
          <select id="estacupSort">
            <option value="arrival">Ordre d'arriv√©e (r√©cent en haut)</option>
            <option value="name">Nom</option>
            <option value="number">N¬∞</option>
          </select>
        </div>
        <div id="estacupList"></div>
      </section>

      <button id="goToDashboard">Retour √† la driver's room</button>
    </div>

    <p id="notAdmin" class="error hidden">Acc√®s refus√© : compte non administrateur.</p>
  </div>
</body>
</html>
